(()=>{var t={620:t=>{t.exports="#version 300 es\nprecision highp float;\n\n// Formal vector of the fragment. After model-view transformation.\nin vec3 fnormal;\n// Fragment's object color.\nin vec4 fcolor;\n// Tex coordinates\nin vec2 fTexCoord;\n// Index of the vertex post view transformation, i.e., relative\n// to the camera.\nin vec3 viewPosition;\n\n// Light direction. After model-view transformation.\nuniform vec3 lightdir;\n// Light color.\nuniform vec3 lightcolor;\n// Eye direction. After model-view transformation.\nuniform vec4 eyedir;\n// Texture\nuniform sampler2D image;\n// Fog Mode\nuniform int fog;\n\nout vec4 fragColor;\n\n// larger scale, smaller specular area\nfloat specularScale = 100.0;\n// larger intensity, brighter specular\nfloat specularIntensity = 0.6;\n// fog is white\nvec4 fogColor = vec4(1, 1, 1, 1);\n\nvoid main() {\n  vec3 fd = normalize(fnormal);\n  vec3 ld = normalize(lightdir);\n\n  // Diffuse light intensity\n  float lambert = max(0.0, dot(fd, ld));\n\n  // Specular light intensity\n  vec3 ed = normalize(vec3(0, 0, 0));\n  // Half way vector eye direction and light direction\n  vec3 h = normalize(ld + ed);\n\n  // Use object color and object specular lighting.\n  float blinnphong = pow(max(0.0, dot(fd, h)), specularScale);\n  vec4 color = texture(image, fTexCoord);\n  color = vec4(color.rgb * lambert + lightcolor * blinnphong * specularIntensity, color.a);\n\n  if(fog > 0) {\n  // Apply fog\n    float d = 0.3;\n    float distance = length(viewPosition);\n  // e^-dz\n    float fogAmount = exp(-d * distance);\n    fogAmount = 1.0 - clamp(fogAmount, 0.0, 1.0);\n    fragColor = mix(color, fogColor, fogAmount);\n  } else {\n    fragColor = color;\n  }\n}\n"},829:t=>{t.exports="#version 300 es\n\nin vec4 position;\nin vec3 normal;\nin vec4 color;\n\nout vec3 fnormal;\nout vec4 fcolor;\nout vec2 fTexCoord;\nout vec3 viewPosition;\n\nuniform mat4 m; // model matrix\nuniform mat4 v; // view matrix\nuniform mat4 p; // projection matrix\nuniform float texWidth;\nuniform float texHeight;\n\nvoid main() {\n  viewPosition = (v * m * position).xyz;\n  gl_Position = p * v * m * position;\n  fnormal = mat3(v) * mat3(m) * normal;\n  fcolor = color;\n  // Scale the texture coordinates to [0, 1] range\n  float texSize = min(texWidth, texHeight);\n  float s = (position.x / 2.0 + 0.5) / texWidth * texSize;\n  float t = (position.y / 2.0 + 0.5) / texHeight * texSize;\n  fTexCoord = vec2(s, t);\n}"}},e={};function o(n){var r=e[n];if(void 0!==r)return r.exports;var a=e[n]={exports:{}};return t[n](a,a.exports,o),a.exports}(()=>{"use strict";function t(t,e){t=Array.from(t),e&&e<t.length&&(t=t.slice(0,e));let o=Math.sqrt(t.map((t=>t*t)).reduce(((t,e)=>t+e)));return t.map((t=>t/o))}function e(t,e){return[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]]}function n(t,e,o){return o=o?Math.min(t.length,e.length,o):Math.min(t.length,e.length),Array.from(t).slice(0,o).map(((t,o)=>t*e[o])).reduce(((t,e)=>t+e))}function r(t,e,o){return o=o?Math.min(t.length,e.length,o):Math.min(t.length,e.length),Array.from(t).slice(0,o).map(((t,o)=>t+e[o]))}function a(t,e,o){return o=o?Math.min(t.length,e.length,o):Math.min(t.length,e.length),Array.from(t).slice(0,o).map(((t,o)=>t-e[o]))}function i(t,e){if(!(16===t.length&&16===e.length||16===t.length&&4===e.length))throw new Error(`Invalid Matrix Length: ${t.length}, ${e.length}`);return 16===e.length?function(t,e){let o=new Float32Array(16);for(let n=0;n<4;n+=1)for(let r=0;r<4;r+=1)for(let a=0;a<4;a+=1)o[n+4*r]+=t[n+4*a]*e[a+4*r];return o}(t,e):function(t,e){let o=new Float32Array(4);for(let n=0;n<4;n+=1)for(let r=0;r<4;r+=1)o[n]+=t[n+4*r]*e[r];return o}(t,e)}function l(){return 1==arguments.length?arguments[0]:Array.prototype.reduce.apply(arguments,[i])}function c(t){let e=Math.cos(t),o=Math.sin(t);return new Float32Array([1,0,0,0,0,e,o,0,0,-o,e,0,0,0,0,1])}function s(e,o){return function(t,e,o){let n=1-e,r=t[0]*t[1]*n,a=t[1]*t[2]*n,i=t[2]*t[0]*n;return new Float32Array([t[0]*t[0]*n+e,r+t[2]*o,i-t[1]*o,0,r-t[2]*o,t[1]*t[1]*n+e,a+t[0]*o,0,i+t[1]*o,a-t[0]*o,t[2]*t[2]*n+e,0,0,0,0,1])}(t(e,3),Math.cos(o),Math.sin(o))}const g=new Float32Array([.075,.16,.292,1]),m=new Float32Array([1,.373,.02,1]),f=new Float32Array([1,1,1]);function h(t,e,o){let n=t.createShader(t.VERTEX_SHADER);if(t.shaderSource(n,e),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS))throw console.error(t.getShaderInfoLog(n)),Error("Vertex shader compilation failed");let r=t.createShader(t.FRAGMENT_SHADER);if(t.shaderSource(r,o),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS))throw console.error(t.getShaderInfoLog(r)),Error("Fragment shader compilation failed");const a=t.createProgram();if(t.attachShader(a,n),t.attachShader(a,r),t.linkProgram(a),!t.getProgramParameter(a,t.LINK_STATUS))throw console.error(t.getProgramInfoLog(a)),Error("Linking failed");return a}function u(t,e,o){const n=t.createVertexArray();t.bindVertexArray(n),Object.entries(e.attributes).forEach((([e,n])=>{if(null==n)return;let r=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,r);let a=new Float32Array(n.flat());t.bufferData(t.ARRAY_BUFFER,a,t.STATIC_DRAW);let i=t.getAttribLocation(o,e);t.vertexAttribPointer(i,n[0].length,t.FLOAT,!1,0,0),t.enableVertexAttribArray(i)}));var r=new Uint16Array(e.triangles.flat()),a=t.createBuffer();return t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a),t.bufferData(t.ELEMENT_ARRAY_BUFFER,r,t.STATIC_DRAW),{mode:t.TRIANGLES,count:r.length,type:t.UNSIGNED_SHORT,vao:n}}function d(t,e,o){let n=t.createTexture();t.activeTexture(t.TEXTURE0+e),t.bindTexture(t.TEXTURE_2D,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,o),t.generateMipmap(t.TEXTURE_2D)}function p(t){return new Promise(((e,o)=>{let n=new Image;n.onload=()=>e(n),n.onerror=o,n.src=t}))}new Float32Array([0,0,0]);const v={};function x(t,e){const{minX:o,maxX:r,minY:i,maxY:l}=v,c=Math.random()*(r-o)+o,s=Math.random()*(l-i)+i,g=Math.random()*(2*Math.PI),m=[c,s],f=[Math.cos(g),Math.sin(g)];let h=0,u=0;for(let o=0;o<t.attributes.position.length;o+=1){const r=t.attributes.position[o],i=n(a(r.slice(0,2),m),f)>=0?1:-1;r[2]+=.035*i*Math.pow(.98,e),h=Math.min(h,r[2]),u=Math.max(u,r[2])}return{minZ:h,maxZ:u}}function w(){v.numVert=101;const o=function(t){const{minX:e,maxX:o,minY:n,maxY:r}=v,a=(o-e)/t,i=(r-n)/t,l=[],c=[];for(let o=0;o<t;o+=1){const r=e+a*o;for(let e=0;e<t;e+=1){const t=n+i*e;l.push([r,t,0])}}for(let e=0;e<100;e+=1)for(let o=0;o<100;o+=1){const n=e*t+o,r=n+1,a=n+t,i=n+t+1;c.push([n,a,r]),c.push([r,a,i])}return{attributes:{position:l},triangles:c,altitudes:Array(t).fill((()=>Array(t).fill(0)))}}(101);let n=0,i=0;for(let t=0;t<100;t+=1)({minZ:n,maxZ:i}=x(o,t));return function(t,e,o){const{minX:n,maxX:r,numVert:a}=v,i=.4*(r-n);t.attributes.position.forEach((t=>{const n=(t[2]-e)*i/(o-e)-i/2;t[2]=n}));for(let e=0;e<t.attributes.position.length;e+=1){let o=Math.floor(e/a),n=e%a;t.altitudes[o][n]=t.attributes.position[e][2]}!function(t,e,o,n,r,a){n=n??(t=>{const n=1-(t-e)/(o-e);return Math.pow(2,n)-1}),r=r??(t=>1-(t-e)/(o-e)),a=a??(t=>{const n=2*Math.abs((t-e)/(o-e)-.5);return Math.pow(2,n)-1}),t.attributes.color=[];for(let e=0;e<t.attributes.position.length;e+=1){const o=t.attributes.position[e][2];t.attributes.color.push([n(o),r(o),a(o),1])}}(t,i/2,-i/2)}(o,n,i),function(o){o.attributes.normal=[];for(let t=0;t<o.attributes.position.length;t+=1)o.attributes.normal.push([0,0,0]);o.triangles.forEach((t=>{const[n,i,l]=t.map((t=>o.attributes.position[t])),c=e(a(i,n),a(l,n)),s=c[2]>0?c:(g=c,Array.from(g).map((t=>-t)));var g;t.forEach((t=>{const e=o.attributes.normal[t];o.attributes.normal[t]=r(e,s)}))}));for(let e=0;e<o.attributes.position.length;e+=1)o.attributes.normal[e]=t(o.attributes.normal[e])}(o),console.log(o),v.geom=u(gl,o,v.program),o.altitudes}const E=[0,1.5,1.5,1],T=t(a([0,0,0,1],[0,1.5,2,1])),A=[0,1,0,0],y=.01,b=-1,M=1,U=(M-b)/100;let _={speed:y,rotSpeed:y,camPos:E,camDir:T,camUp:A,slot:1,onTheGround:!1,lightdir:t([3,0,3,1]),fog:0},P=[];const R={};function L(){let{camDir:o,camUp:n}=_;return[...t(e(n,o)),0]}function F(t,e,o,n){let a=r((i=e,l=o,Array.from(i).map((t=>t*l))),t);var i,l;if(!n)return a;console.log(a);let c=S(a);return a[1]=c,console.log(a),a}function S(t){let[e,o,n,r]=t;e=(e-b)/U,o=(-n-b)/U;let i=[[Math.floor(e),Math.floor(o)],[Math.floor(e),Math.ceil(o)],[Math.ceil(e),Math.floor(o)],[Math.ceil(e),Math.ceil(o)]],l=i.map((([t,e])=>_.altitudes[t][e])),c=i.map((t=>{return n=a(t,[e,o]),Math.sqrt(n.reduce(((t,e)=>t+e*e),0));var n})),s=c.reduce(((t,e)=>t+e)),g=0;for(let t=0;t<4;t+=1)g+=c[t]/s*l[t];return g}function D(o){gl.clearColor(...g),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);let[n,r,a,i]=_.camPos;if(_.onTheGround&&(n<b||n>M||a<b||a>M)&&(_.onTheGround=!1,_.speed=y),R.w&&(_.camPos=F(_.camPos,_.camDir,_.speed,_.onTheGround)),R.s&&(_.camPos=F(_.camPos,_.camDir,-_.speed,_.onTheGround)),R.a){let t=L();_.camPos=F(_.camPos,t,_.speed,_.onTheGround)}if(R.d){let t=L();_.camPos=F(_.camPos,t,-_.speed,_.onTheGround)}if(R.ArrowUp){let e=L(),o=_.rotSpeed;_.camDir=t(l(s(e,-o),_.camDir)),_.camUp=t(l(s(e,-o),_.camUp))}if(R.ArrowDown){let e=L(),o=_.rotSpeed;_.camDir=t(l(s(e,o),_.camDir)),_.camUp=t(l(s(e,o),_.camUp))}if(R.ArrowLeft){let e=_.camUp,o=_.rotSpeed;_.camDir=t(l(s(e,o),_.camDir))}if(R.ArrowRight){let e=_.camUp,o=_.rotSpeed;_.camDir=t(l(s(e,-o),_.camDir))}R.Escape&&(_={..._,speed:y,camPos:E,camDir:T,camUp:A,onTheGround:!1}),_.v=function(o,n,r){let a=t(e(n,r)),i=e(a,n);return l(new Float32Array([a[0],i[0],-n[0],0,a[1],i[1],-n[1],0,a[2],i[2],-n[2],0,0,0,0,1]),(c=-o[0],s=-o[1],g=-o[2],new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,c,s,g,1])));var c,s,g}(_.camPos,_.camDir,_.camUp),function(t,e){const{camPos:o,v:n,p:r,slot:a,fog:i,texWidth:s,texHeight:g}=e,{program:m,geom:h,lightdir:u}=v;gl.useProgram(m);const d=c(-Math.PI/2),p=gl.getUniformLocation(m,"m");gl.uniformMatrix4fv(p,!1,d);const x=gl.getUniformLocation(m,"v");gl.uniformMatrix4fv(x,!1,n);const w=gl.getUniformLocation(m,"p");gl.uniformMatrix4fv(w,!1,r);const E=t/1e3,T=l(c(.5*Math.cos(E/2)-.5),u),A=gl.getUniformLocation(m,"lightdir");gl.uniform3fv(A,new Float32Array(T.slice(0,3)));const y=gl.getUniformLocation(m,"lightcolor"),b=f;gl.uniform3fv(y,b);const M=gl.getUniformLocation(m,"eyedir");gl.uniform4fv(M,o);const U=gl.getUniformLocation(m,"image");gl.uniform1i(U,a);const _=gl.getUniformLocation(m,"fog");gl.uniform1i(_,i);const P=gl.getUniformLocation(m,"texWidth");gl.uniform1f(P,s);const R=gl.getUniformLocation(m,"texHeight");gl.uniform1f(R,g),gl.bindVertexArray(h.vao),gl.drawElements(h.mode,h.count,h.type,0)}(o,_);for(let t of P)t(o,_);requestAnimationFrame(D)}function I(){let t=document.querySelector("canvas");document.body.style.margin="0",t.style.width="100%",t.style.height="100%",t.width=t.clientWidth,t.height=t.clientHeight,t.style.width="",t.style.height="",window.gl&&(gl.viewport(0,0,t.width,t.height),_.p=function(t,e,o,n,r){var a,i;{let t=void 0===r?n:n/r;a=(i=1/Math.tan(.5))/t}return new Float32Array([a,0,0,0,0,i,0,0,0,0,-10.1/9.9,-1,0,0,2/-9.9,0])}(0,0,0,t.width,t.height))}window.addEventListener("load",(async function(e){window.gl=document.querySelector("canvas").getContext("webgl2",{antialias:!1,depth:!0,preserveDrawingBuffer:!0}),gl.enable(gl.DEPTH_TEST),await async function(){const e=o(829),n=o(620),r=h(gl,e,n);v.program=r,v.lightdir=t([3,0,3,1]),v.minX=-1,v.maxX=1,v.minY=-1,v.maxY=1}(),_.altitudes=w(),I(),gl.clearColor(...g),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);let n=await p("./farm.jpg");d(gl,1,n);let r=n.width,a=n.height;_.texWidth=r,_.texHeight=a;let i=window.location.hash.slice(1);if(i){let t=i.replace("obj","jpg");(l=i,c=t,s=2,fetch(l).then((t=>t.text())).then((async t=>{const e=[],o=[],n=[],r=[],a=[],i=[],l=[],g=[],v=[];let x,w;t.split(/\n/).forEach((t=>{const c=t.split(/\s+/);switch(c[0]){case"v":e.push(c.slice(1,4).map((t=>Number.parseFloat(t)))),7===c.length?o.push(c.slice(4,7).map((t=>Number.parseFloat(t)))):o.push(Array.from(m));break;case"vn":n.push(c.slice(1,4).map((t=>Number.parseFloat(t))));break;case"vt":r.push(c.slice(1,3).map((t=>Number.parseFloat(t))));break;case"f":let t=c.slice(1).map((t=>t.split("/"))).map((t=>{let c=a.length,s=Number.parseInt(t[0])-1;if(a.push(e[s]),i.push(o[s]),n.length>0){let e=Number.parseInt(t[2])-1;l.push(n[e])}if(r.length>0){let e=Number.parseInt(t[1])-1;g.push(r[e])}return c}));for(let e=1;e<t.length-1;e+=1)v.push([t[0],t[e],t[e+1]])}})),l.length>0&&g.length>0?(console.log("Normal + Texture Coordinates"),x=await fetch("./glsl/vnt_vertex.glsl").then((t=>t.text())),w=await fetch("./glsl/vnt_frag.glsl").then((t=>t.text()))):l.length>0?(console.log("Normal"),x=await fetch("./glsl/vn_vertex.glsl").then((t=>t.text())),w=await fetch("./glsl/vn_frag.glsl").then((t=>t.text()))):g.length>0?(console.log("Texture Coordinates"),x=await fetch("./glsl/vt_vertex.glsl").then((t=>t.text())),w=await fetch("./glsl/vt_frag.glsl").then((t=>t.text()))):(x=await fetch("./glsl/v_vertex.glsl").then((t=>t.text())),w=await fetch("./glsl/v_frag.glsl").then((t=>t.text())));let E=h(gl,x,w),T={attributes:{position:a,color:i,normal:l.length>0?l:void 0,tCoord:g.length>0?g:void 0},triangles:v};console.log(T);let A=u(gl,T,E);if(g.length>0){let t=await p(c);d(gl,s,t)}return(t,e)=>{const{v:o,p:n,lightdir:r,fog:a}=e;gl.useProgram(E);const i=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),c=gl.getUniformLocation(E,"m");gl.uniformMatrix4fv(c,!1,i);const m=gl.getUniformLocation(E,"v");gl.uniformMatrix4fv(m,!1,o);const h=gl.getUniformLocation(E,"p");if(gl.uniformMatrix4fv(h,!1,n),l.length>0){const t=gl.getUniformLocation(E,"lightdir");gl.uniform3fv(t,r.slice(0,3));const e=gl.getUniformLocation(E,"lightcolor"),o=f;gl.uniform3fv(e,o)}if(g.length>0){const t=gl.getUniformLocation(E,"image");gl.uniform1i(t,s)}const u=gl.getUniformLocation(E,"fog");gl.uniform1i(u,a),gl.bindVertexArray(A.vao),gl.drawElements(A.mode,A.count,A.type,0)}}))).then((t=>{P.push(t)})).catch((t=>{console.log(t)}))}var l,c,s;requestAnimationFrame(D)})),window.addEventListener("resize",I),window.addEventListener("keydown",(t=>{"g"===t.key?_.onTheGround?(_.onTheGround=!1,_.speed=y):function(){let[t,e,o,n]=_.camPos;return t>=b&&t<=M&&-o>=b&&-o<=M}()&&(_.onTheGround=!0,_.speed=.001,_.camPos[1]=S(_.camPos)):"f"===t.key?_.fog=1-_.fog:R[t.key]=!0})),window.addEventListener("keyup",(t=>{R[t.key]=!1}))})()})();